{% extends "base.html" %}

{% block title %}Statistics{% endblock %}

{% block content %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<style>
    /* Dark theme overrides for DataTables */
    .dataTables_wrapper {
        color: rgba(255, 255, 255, 0.8);
    }
    .dataTables_length select,
    .dataTables_filter input {
        background-color: #2b3035 !important;
        border: 1px solid #495057 !important;
        color: rgba(255, 255, 255, 0.8) !important;
    }
    .dataTables_length select option {
        background-color: #2b3035;
    }
    .dataTables_info {
        color: rgba(255, 255, 255, 0.6) !important;
    }
    .paginate_button {
        color: rgba(255, 255, 255, 0.8) !important;
    }
    .paginate_button.current {
        background: #0d6efd !important;
        border-color: #0d6efd !important;
        color: white !important;
    }
    .paginate_button:hover:not(.current) {
        background: #2b3035 !important;
        border-color: #495057 !important;
    }
    table.dataTable tbody tr {
        background-color: #212529 !important;
    }
    table.dataTable tbody tr:hover {
        background-color: #2b3035 !important;
    }
    .table-dark {
        --bs-table-striped-bg: #2b3035;
    }
    .filter-input, .filter-operator {
        background-color: #2b3035 !important;
        border-color: #495057 !important;
        color: rgba(255, 255, 255, 0.8) !important;
    }
    .filter-operator option {
        background-color: #2b3035;
    }
</style>

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex align-items-center">
                <div class="rounded-circle bg-primary bg-opacity-15 p-3 me-3">
                    <i class="bi bi-bar-chart-line text-primary fs-4"></i>
                </div>
                <div>
                    <h1 class="h2 mb-1 text-light">Statistics Dashboard</h1>
                    <p class="text-secondary mb-0">Comprehensive overview of books, authors, and sales performance</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Table 1: Authors Statistics -->
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-header border-secondary p-3">
            <div class="d-flex align-items-center">
                <div class="rounded-circle bg-info bg-opacity-15 p-2 me-3">
                    <i class="bi bi-people text-info"></i>
                </div>
                <h3 class="card-title mb-0 text-light">Authors Statistics</h3>
            </div>
        </div>
        <div class="card-body p-4">
    <div class="table-responsive">
        <table id="authorsTable" class="table table-dark table-striped table-bordered border-secondary">
            <thead class="bg-dark">
                <tr>
                    <th scope="col" class="text-center">#</th>
                    <th scope="col">
                        <a href="?sort=name&direction={% if current_sort_field == 'name' and current_sort_direction == 'asc' %}desc{% else %}asc{% endif %}" 
                           class="text-decoration-none text-light d-flex align-items-center">
                            <i class="bi bi-person me-2"></i>Author
                            {% if current_sort_field == 'name' %}
                                {% if current_sort_direction == 'asc' %}
                                    <i class="bi bi-arrow-up ms-2"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down ms-2"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th scope="col">
                        <a href="?sort=number_of_books&direction={% if current_sort_field == 'number_of_books' and current_sort_direction == 'asc' %}desc{% else %}asc{% endif %}">
                            Number of Books
                            {% if current_sort_field == 'number_of_books' %}
                                {% if current_sort_direction == 'asc' %}
                                    <i class="bi bi-arrow-up"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th scope="col">
                        <a href="?sort=average_score&direction={% if current_sort_field == 'average_score' and current_sort_direction == 'asc' %}desc{% else %}asc{% endif %}">
                            Average Score
                            {% if current_sort_field == 'average_score' %}
                                {% if current_sort_direction == 'asc' %}
                                    <i class="bi bi-arrow-up"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th scope="col">
                        <a href="?sort=total_sales&direction={% if current_sort_field == 'total_sales' and current_sort_direction == 'asc' %}desc{% else %}asc{% endif %}">
                            Total Sales
                            {% if current_sort_field == 'total_sales' %}
                                {% if current_sort_direction == 'asc' %}
                                    <i class="bi bi-arrow-up"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                </tr>
                <tr class="filter-row">
                    <th scope="col"></th>
                    <th scope="col">
                        <div class="filter-container">
                            <input type="text" class="filter-input text-filter form-control form-control-sm" placeholder="Filter Author" style="width: 100%;">
                        </div>
                    </th>
                    <th scope="col">
                        <div class="filter-container d-flex align-items-center" style="gap: 4px;">
                            <select class="filter-operator form-select form-select-sm" style="width: 60px;">
                                <option value="=">=</option>
                                <option value=">">&gt;</option>
                                <option value="<">&lt;</option>
                                <option value=">=">&ge;</option>
                                <option value="<=">&le;</option>
                            </select>
                            <input type="number" class="filter-input numeric-filter form-control form-control-sm" placeholder="Filter" style="flex: 1;">
                        </div>
                    </th>
                    <th scope="col">
                        <div class="filter-container d-flex align-items-center" style="gap: 4px;">
                            <select class="filter-operator form-select form-select-sm" style="width: 60px;">
                                <option value="=">=</option>
                                <option value=">">&gt;</option>
                                <option value="<">&lt;</option>
                                <option value=">=">&ge;</option>
                                <option value="<=">&le;</option>
                            </select>
                            <input type="number" step="0.01" class="filter-input numeric-filter form-control form-control-sm" placeholder="Filter" style="flex: 1;">
                        </div>
                    </th>
                    <th scope="col">
                        <div class="filter-container d-flex align-items-center" style="gap: 4px;">
                            <select class="filter-operator form-select form-select-sm" style="width: 60px;">
                                <option value="=">=</option>
                                <option value=">">&gt;</option>
                                <option value="<">&lt;</option>
                                <option value=">=">&ge;</option>
                                <option value="<=">&le;</option>
                            </select>
                            <input type="number" class="filter-input numeric-filter form-control form-control-sm" placeholder="Filter" style="flex: 1;">
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for author in authors_stats %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ author.name }}</td>
                    <td>{{ author.number_of_books }}</td>
                    <td>{{ author.average_score|floatformat:2 }}</td>
                    <td>{{ author.total_sales }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    </div>
    </div>

    <!-- Table 2: Top 10 Rated Books -->
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-header border-secondary p-3">
            <div class="d-flex align-items-center">
                <div class="rounded-circle bg-warning bg-opacity-15 p-2 me-3">
                    <i class="bi bi-star text-warning"></i>
                </div>
                <h3 class="card-title mb-0 text-light">Top 10 Rated Books</h3>
            </div>
        </div>
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table table-dark table-striped table-bordered border-secondary">
                    <thead class="bg-dark">
                        <tr>
                            <th scope="col" class="text-center">#</th>
                            <th scope="col">
                                <i class="bi bi-book me-2"></i>Book Name
                            </th>
                            <th scope="col">
                                <i class="bi bi-star-half me-2"></i>Average Score
                            </th>
                            <th scope="col">
                                <i class="bi bi-hand-thumbs-up me-2"></i>Best Review
                            </th>
                            <th scope="col">
                                <i class="bi bi-hand-thumbs-down me-2"></i>Worst Review
                            </th>
                        </tr>
                    </thead>
            <tbody>
                {% for book in top_rated_books %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ book.name }}</td>
                    <td>{{ book.average_score|floatformat:2 }}</td>
                    <td>{{ book.best_review_upvotes }}</td>
                    <td>{{ book.worst_review_upvotes }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    </div>
    </div>

    <!-- Table 3: Top 50 Selling Books -->
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-header border-secondary p-3">
            <div class="d-flex align-items-center">
                <div class="rounded-circle bg-success bg-opacity-15 p-2 me-3">
                    <i class="bi bi-graph-up-arrow text-success"></i>
                </div>
                <h3 class="card-title mb-0 text-light">Top 50 Selling Books</h3>
            </div>
        </div>
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table table-dark table-striped table-bordered border-secondary">
                    <thead class="bg-dark">
                        <tr>
                            <th scope="col" class="text-center">#</th>
                            <th scope="col">
                                <i class="bi bi-book me-2"></i>Book Name
                            </th>
                            <th scope="col">
                                <i class="bi bi-cart me-2"></i>Total Sales
                            </th>
                            <th scope="col">
                                <i class="bi bi-person-badge me-2"></i>Author Sales
                            </th>
                            <th scope="col">
                                <i class="bi bi-trophy me-2"></i>Top 5 in Publication Year
                            </th>
                        </tr>
                    </thead>
            <tbody>
                {% for book in top_selling_books %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ book.name }}</td>
                    <td>{{ book.calculated_total_sales }}</td>
                    <td>{{ book.author_total_sales }}</td>
                    <td>
                        {% if book.is_top_5_in_year %}
                            <span class="badge bg-success bg-opacity-25 text-success border border-success">
                                <i class="bi bi-check-circle me-1"></i>Yes
                            </span>
                        {% else %}
                            <span class="badge bg-danger bg-opacity-25 text-danger border border-danger">
                                <i class="bi bi-x-circle me-1"></i>No
                            </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function() {
    let table = $('#authorsTable').DataTable({
        paging: true,
        ordering: true,
        searching: true,
        initComplete: function () {
            var api = this.api();

            api.columns().every(function (index) {
                var column = this;
                var header = $(column.header());
                var filterRow = header.closest('thead').find('tr.filter-row');
                var filterCell = $(filterRow).find('th').eq(index);

                if (filterCell.length === 0) return;

                if (index === 1) {
                    var input = filterCell.find('input.text-filter');
                    input.on('keyup change clear', function () {
                        if (column.search() !== this.value) {
                            column.search(this.value).draw();
                        }
                    });
                } else if (index === 2 || index === 3 || index === 4) {
                    var input = filterCell.find('input.numeric-filter');
                    var operatorSelect = filterCell.find('select.filter-operator');

                    function filterFunction(settings, data, dataIndex) {
                        var val = data[index];
                        var filterVal = input.val();
                        var operator = operatorSelect.val();

                        if (filterVal === '') {
                            return true;
                        }

                        var cellValue = parseFloat(val);
                        var filterNumber = parseFloat(filterVal);

                        if (isNaN(cellValue) || isNaN(filterNumber)) {
                            return false;
                        }

                        switch(operator) {
                            case '=':
                                return cellValue === filterNumber;
                            case '>':
                                return cellValue > filterNumber;
                            case '<':
                                return cellValue < filterNumber;
                            case '>=':
                                return cellValue >= filterNumber;
                            case '<=':
                                return cellValue <= filterNumber;
                            default:
                                return true;
                        }
                    }

                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        if (settings.nTable !== table.table().node()) {
                            return true;
                        }
                        return filterFunction(settings, data, dataIndex);
                    });

                    function redrawTable() {
                        table.draw();
                    }

                    input.on('keyup change clear', redrawTable);
                    operatorSelect.on('change', redrawTable);
                }
            });
        }
    });
});
</script>

{% endblock %}