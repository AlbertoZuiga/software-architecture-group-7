{% extends "base.html" %}

{% block title %}Statistics{% endblock %}

{% block content %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<style>
    html {
        scroll-behavior: smooth;
    }
    [id] {
        scroll-margin-top: 2rem;
    }
    /* DataTables Dark Theme */
    .dataTables_wrapper {
        color: rgba(255, 255, 255, 0.9);
    }
    .dataTables_length select,
    .dataTables_filter input {
        background-color: #2b3035 !important;
        border: 1px solid #495057 !important;
        color: #fff !important;
        border-radius: 6px !important;
        padding: 0.5rem !important;
        transition: all 0.2s ease-in-out !important;
    }
    .dataTables_length select:focus,
    .dataTables_filter input:focus {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    }
    .dataTables_length select option {
        background-color: #2b3035;
        padding: 8px;
    }
    .dataTables_info {
        color: rgba(255, 255, 255, 0.7) !important;
        padding: 1rem 0 !important;
    }
    .dataTables_paginate {
        padding: 1rem 0 !important;
    }
    .paginate_button {
        color: rgba(255, 255, 255, 0.9) !important;
        padding: 0.5rem 0.75rem !important;
        margin: 0 0.25rem !important;
        border-radius: 6px !important;
        transition: all 0.2s ease-in-out !important;
    }
    .paginate_button.current {
        background: #0d6efd !important;
        border-color: #0d6efd !important;
        color: white !important;
        font-weight: 600 !important;
    }
    .paginate_button:hover:not(.current) {
        background: #2b3035 !important;
        border-color: #495057 !important;
    }
    
    /* Table Styling */
    table.dataTable {
        border-collapse: separate !important;
        border-spacing: 0 0.5rem !important;
        margin: 1rem 0 !important;
    }
    table.dataTable thead th {
        border-bottom: 2px solid #495057 !important;
        padding: 1rem !important;
        font-weight: 600 !important;
        color: #fff !important;
    }
    table.dataTable tbody tr {
        background-color: #2b3035 !important;
        transition: transform 0.2s ease-in-out !important;
    }
    table.dataTable tbody tr:hover {
        background-color: #343a40 !important;
        transform: translateY(-2px);
    }
    table.dataTable tbody td {
        padding: 1rem !important;
        vertical-align: middle !important;
        border-top: 1px solid #495057 !important;
    }
    
    /* Filters Styling */
    .filter-input, 
    .filter-operator {
        background-color: #2b3035 !important;
        border: 1px solid #6c757d !important;
        color: #fff !important;
        font-weight: 500;
        border-radius: 6px !important;
        transition: all 0.2s ease-in-out !important;
    }
    .filter-input:focus, 
    .filter-operator:focus {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    }
    .filter-input::placeholder {
        color: rgba(255, 255, 255, 0.6) !important;
        font-weight: normal;
    }
    .filter-operator {
        background-color: #343a40 !important;
    }
    .filter-operator option {
        background-color: #343a40;
        color: #fff;
        padding: 8px;
    }
    .filter-container {
        margin-bottom: 0.5rem;
    }
    .filter-container label {
        color: #0d6efd !important;
        font-weight: 500;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }
    .filter-container label i {
        margin-right: 0.5rem;
    }
    .filter-row th {
        padding: 1rem !important;
        background-color: #212529 !important;
        border-bottom: none !important;
    }
    
    /* Card Enhancements */
    .stats-card {
        transition: all 0.2s ease-in-out;
        position: relative;
    }
    .stats-card:hover {
        transform: translateY(-4px);
        border-color: var(--bs-primary) !important;
    }
    .stats-card::after {
        content: '';
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        width: 24px;
        height: 24px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease-in-out;
    }
    .stats-card:hover::after {
        background: rgba(13, 110, 253, 0.2);
        transform: scale(1.2);
    }
    .stats-card .arrow-icon {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        opacity: 0.7;
        transition: all 0.2s ease-in-out;
    }
    .stats-card:hover .arrow-icon {
        opacity: 1;
        transform: translateX(4px);
    }
    .card-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    
    /* Badges and Icons */
    .badge {
        padding: 0.5rem 0.75rem !important;
        font-weight: 500 !important;
    }
    .icon-circle {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    /* Utilities */
    .text-gradient {
        background: linear-gradient(45deg, #0d6efd, #0dcaf0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .shadow-soft {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
</style>

<div class="container mt-5">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex align-items-center mb-4">
                <div class="icon-circle bg-primary bg-opacity-15 p-3 me-3">
                    <i class="bi bi-bar-chart-line text-primary fs-4"></i>
                </div>
                <div>
                    <h1 class="display-6 mb-1 text-light text-gradient">Statistics Dashboard</h1>
                    <p class="text-secondary mb-0">Comprehensive overview of books, authors, and sales performance</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <a href="#authors-stats" class="text-decoration-none">
                <div class="card bg-dark border-primary border-opacity-25 stats-card shadow-soft">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-primary bg-opacity-15 me-3">
                                <i class="bi bi-people text-primary"></i>
                            </div>
                            <h5 class="card-title mb-0 text-light">Total Authors</h5>
                        </div>
                        <h2 class="display-6 mb-2 text-light">{{ authors_stats|length }}</h2>
                        <p class="text-secondary mb-0">
                            Active content creators
                        </p>
                        <i class="bi bi-arrow-right-circle arrow-icon"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="#top-rated" class="text-decoration-none">
                <div class="card bg-dark border-warning border-opacity-25 stats-card shadow-soft">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-warning bg-opacity-15 me-3">
                                <i class="bi bi-book text-warning"></i>
                            </div>
                            <h5 class="card-title mb-0 text-light">Top Rated Books</h5>
                        </div>
                        <h2 class="display-6 mb-2 text-light">{{ top_rated_books|length }}</h2>
                        <p class="text-secondary mb-0">
                            Highest rated publications
                        </p>
                        <i class="bi bi-arrow-right-circle arrow-icon"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="#best-sellers" class="text-decoration-none">
                <div class="card bg-dark border-success border-opacity-25 stats-card shadow-soft">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-success bg-opacity-15 me-3">
                                <i class="bi bi-graph-up-arrow text-success"></i>
                            </div>
                            <h5 class="card-title mb-0 text-light">Best Sellers</h5>
                        </div>
                        <h2 class="display-6 mb-2 text-light">{{ top_selling_books|length }}</h2>
                        <p class="text-secondary mb-0">
                            Top performing books
                        </p>
                        <i class="bi bi-arrow-right-circle arrow-icon"></i>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Table 1: Authors Statistics -->
    <div class="card bg-dark border-secondary mb-4 shadow-soft">
        <div class="card-header border-secondary p-3">
            <div class="d-flex align-items-center">
                <div class="rounded-circle bg-info bg-opacity-15 p-2 me-3">
                    <i class="bi bi-people text-info"></i>
                </div>
                <h3 class="card-title mb-0 text-light">Authors Statistics</h3>
            </div>
        </div>
        <div class="card-body p-4">
    <div class="table-responsive">
        <table id="authorsTable" class="table table-dark table-striped table-bordered border-secondary">
            <thead class="bg-dark">
                <tr>
                    <th scope="col" class="text-center">#</th>
                    <th scope="col">
                        <a href="?sort=name&direction={% if current_sort_field == 'name' and current_sort_direction == 'asc' %}desc{% else %}asc{% endif %}" 
                           class="text-decoration-none text-light d-flex align-items-center">
                            <i class="bi bi-person me-2"></i>Author
                            {% if current_sort_field == 'name' %}
                                {% if current_sort_direction == 'asc' %}
                                    <i class="bi bi-arrow-up ms-2"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down ms-2"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th scope="col">
                        <a href="?sort=number_of_books&direction={% if current_sort_field == 'number_of_books' and current_sort_direction == 'asc' %}desc{% else %}asc{% endif %}">
                            Number of Books
                            {% if current_sort_field == 'number_of_books' %}
                                {% if current_sort_direction == 'asc' %}
                                    <i class="bi bi-arrow-up"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th scope="col">
                        <a href="?sort=average_score&direction={% if current_sort_field == 'average_score' and current_sort_direction == 'asc' %}desc{% else %}asc{% endif %}">
                            Average Score
                            {% if current_sort_field == 'average_score' %}
                                {% if current_sort_direction == 'asc' %}
                                    <i class="bi bi-arrow-up"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th scope="col">
                        <a href="?sort=total_sales&direction={% if current_sort_field == 'total_sales' and current_sort_direction == 'asc' %}desc{% else %}asc{% endif %}">
                            Total Sales
                            {% if current_sort_field == 'total_sales' %}
                                {% if current_sort_direction == 'asc' %}
                                    <i class="bi bi-arrow-up"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                </tr>
                <tr class="filter-row">
                    <th scope="col"></th>
                    <th scope="col">
                        <div class="filter-container">
                            <label for="authorFilter" class="d-block text-primary mb-2">
                                <i class="bi bi-funnel me-1"></i>Filter by Author
                            </label>
                            <input type="text" 
                                   id="authorFilter"
                                   class="filter-input text-filter form-control form-control-sm" 
                                   placeholder="Enter author name" 
                                   aria-label="Filter by author name"
                                   style="width: 100%;">
                        </div>
                    </th>
                    <th scope="col">
                        <div class="filter-container">
                            <label for="booksFilter" class="d-block text-primary mb-2">
                                <i class="bi bi-funnel me-1"></i>Filter by Books
                            </label>
                            <div class="d-flex align-items-center" style="gap: 4px;">
                                <select id="booksFilterOp" 
                                        class="filter-operator form-select form-select-sm" 
                                        style="width: 60px;"
                                        aria-label="Select comparison operator for books">
                                    <option value="=">=</option>
                                    <option value=">">&gt;</option>
                                    <option value="<">&lt;</option>
                                    <option value=">=">&ge;</option>
                                    <option value="<=">&le;</option>
                                </select>
                                <input type="number" 
                                       id="booksFilter"
                                       class="filter-input numeric-filter form-control form-control-sm" 
                                       placeholder="Enter number" 
                                       aria-label="Filter by number of books"
                                       style="flex: 1;">
                            </div>
                        </div>
                    </th>
                    <th scope="col">
                        <div class="filter-container">
                            <label for="scoreFilter" class="d-block text-primary mb-2">
                                <i class="bi bi-funnel me-1"></i>Filter by Score
                            </label>
                            <div class="d-flex align-items-center" style="gap: 4px;">
                                <select id="scoreFilterOp"
                                        class="filter-operator form-select form-select-sm" 
                                        style="width: 60px;"
                                        aria-label="Select comparison operator for score">
                                    <option value="=">=</option>
                                    <option value=">">&gt;</option>
                                    <option value="<">&lt;</option>
                                    <option value=">=">&ge;</option>
                                    <option value="<=">&le;</option>
                                </select>
                                <input type="number" 
                                       id="scoreFilter"
                                       step="0.01" 
                                       class="filter-input numeric-filter form-control form-control-sm" 
                                       placeholder="Enter score" 
                                       aria-label="Filter by average score"
                                       style="flex: 1;">
                        </div>
                    </th>
                    <th scope="col">
                        <div class="filter-container d-flex align-items-center" style="gap: 4px;">
                            <select class="filter-operator form-select form-select-sm" style="width: 60px;">
                                <option value="=">=</option>
                                <option value=">">&gt;</option>
                                <option value="<">&lt;</option>
                                <option value=">=">&ge;</option>
                                <option value="<=">&le;</option>
                            </select>
                            <input type="number" class="filter-input numeric-filter form-control form-control-sm" placeholder="Filter" style="flex: 1;">
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for author in authors_stats %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <a href="{% url 'authors:show' author.id %}" class="text-decoration-none text-light">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-primary bg-opacity-10 p-2 me-2" style="width: 35px; height: 35px;">
                                    <i class="bi bi-person text-primary"></i>
                                </div>
                                <span>{{ author.name }}</span>
                            </div>
                        </a>
                    </td>
                    <td>{{ author.number_of_books }}</td>
                    <td>{{ author.average_score|floatformat:2 }}</td>
                    <td>{{ author.total_sales }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    </div>
    </div>

    <!-- Table 2: Top 10 Rated Books -->
    <div id="top-rated" class="card bg-dark border-warning border-opacity-25 mb-4 shadow-soft">
        <div class="card-header border-warning border-opacity-25 p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="icon-circle bg-warning bg-opacity-15 me-3">
                        <i class="bi bi-star text-warning"></i>
                    </div>
                    <div>
                        <h3 class="card-title h4 mb-1 text-light">Top 10 Rated Books</h3>
                        <p class="text-secondary mb-0">Highest rated books based on user reviews</p>
                    </div>
                </div>
                <div class="badge bg-warning bg-opacity-25 text-warning border border-warning">
                    <i class="bi bi-trophy me-2"></i>Top Performers
                </div>
            </div>
        </div>
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table table-dark table-striped table-bordered border-secondary">
                    <thead class="bg-dark">
                        <tr>
                            <th scope="col" class="text-center">#</th>
                            <th scope="col">
                                <i class="bi bi-book me-2"></i>Book Name
                            </th>
                            <th scope="col">
                                <i class="bi bi-star-half me-2"></i>Average Score
                            </th>
                            <th scope="col">
                                <i class="bi bi-hand-thumbs-up me-2"></i>Best Review
                            </th>
                            <th scope="col">
                                <i class="bi bi-hand-thumbs-down me-2"></i>Worst Review
                            </th>
                        </tr>
                    </thead>
            <tbody>
                {% for book in top_rated_books %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <a href="{% url 'books:show' book.id %}" class="text-decoration-none text-light">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-warning bg-opacity-10 p-2 me-2" style="width: 35px; height: 35px;">
                                    <i class="bi bi-book text-warning"></i>
                                </div>
                                <span>{{ book.name }}</span>
                            </div>
                        </a>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="text-warning me-2">
                                <i class="bi bi-star-fill"></i>
                            </div>
                            {{ book.average_score|floatformat:2 }}
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="text-success me-2">
                                <i class="bi bi-hand-thumbs-up-fill"></i>
                            </div>
                            {{ book.best_review_upvotes }}
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="text-danger me-2">
                                <i class="bi bi-hand-thumbs-down-fill"></i>
                            </div>
                            {{ book.worst_review_upvotes }}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    </div>
    </div>

    <!-- Table 3: Top 50 Selling Books -->
    <div id="best-sellers" class="card bg-dark border-success border-opacity-25 mb-4 shadow-soft">
        <div class="card-header border-success border-opacity-25 p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="icon-circle bg-success bg-opacity-15 me-3">
                        <i class="bi bi-graph-up-arrow text-success"></i>
                    </div>
                    <div>
                        <h3 class="card-title h4 mb-1 text-light">Top 50 Selling Books</h3>
                        <p class="text-secondary mb-0">Best-selling books ranked by total sales</p>
                    </div>
                </div>
                <div class="badge bg-success bg-opacity-25 text-success border border-success">
                    <i class="bi bi-cash-stack me-2"></i>Sales Leaders
                </div>
            </div>
        </div>
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table table-dark table-striped table-bordered border-secondary">
                    <thead class="bg-dark">
                        <tr>
                            <th scope="col" class="text-center">#</th>
                            <th scope="col">
                                <i class="bi bi-book me-2"></i>Book Name
                            </th>
                            <th scope="col">
                                <i class="bi bi-cart me-2"></i>Total Sales
                            </th>
                            <th scope="col">
                                <i class="bi bi-person-badge me-2"></i>Author Sales
                            </th>
                            <th scope="col">
                                <i class="bi bi-trophy me-2"></i>Top 5 in Publication Year
                            </th>
                        </tr>
                    </thead>
            <tbody>
                {% for book in top_selling_books %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <a href="{% url 'books:show' book.id %}" class="text-decoration-none text-light">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-success bg-opacity-10 p-2 me-2" style="width: 35px; height: 35px;">
                                    <i class="bi bi-book text-success"></i>
                                </div>
                                <span>{{ book.name }}</span>
                            </div>
                        </a>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="text-success me-2">
                                <i class="bi bi-graph-up"></i>
                            </div>
                            {{ book.calculated_total_sales }}
                        </div>
                    </td>
                    <td>
                        <a href="{% url 'authors:show' book.author.id %}" class="text-decoration-none text-light">
                            <div class="d-flex align-items-center">
                                <div class="text-primary me-2">
                                    <i class="bi bi-person"></i>
                                </div>
                                {{ book.author_total_sales }}
                            </div>
                        </a>
                    </td>
                    <td>
                        {% if book.is_top_5_in_year %}
                            <span class="badge bg-success bg-opacity-25 text-success border border-success">
                                <i class="bi bi-trophy-fill me-1"></i>Top 5
                            </span>
                        {% else %}
                            <span class="badge bg-secondary bg-opacity-25 text-secondary border border-secondary">
                                <i class="bi bi-dash-circle me-1"></i>Not in Top 5
                            </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function() {
    let table = $('#authorsTable').DataTable({
        paging: true,
        ordering: true,
        searching: true,
        initComplete: function () {
            var api = this.api();

            api.columns().every(function (index) {
                var column = this;
                var header = $(column.header());
                var filterRow = header.closest('thead').find('tr.filter-row');
                var filterCell = $(filterRow).find('th').eq(index);

                if (filterCell.length === 0) return;

                if (index === 1) {
                    var input = filterCell.find('input.text-filter');
                    input.on('keyup change clear', function () {
                        if (column.search() !== this.value) {
                            column.search(this.value).draw();
                        }
                    });
                } else if (index === 2 || index === 3 || index === 4) {
                    var input = filterCell.find('input.numeric-filter');
                    var operatorSelect = filterCell.find('select.filter-operator');

                    function filterFunction(settings, data, dataIndex) {
                        var val = data[index];
                        var filterVal = input.val();
                        var operator = operatorSelect.val();

                        if (filterVal === '') {
                            return true;
                        }

                        var cellValue = parseFloat(val);
                        var filterNumber = parseFloat(filterVal);

                        if (isNaN(cellValue) || isNaN(filterNumber)) {
                            return false;
                        }

                        switch(operator) {
                            case '=':
                                return cellValue === filterNumber;
                            case '>':
                                return cellValue > filterNumber;
                            case '<':
                                return cellValue < filterNumber;
                            case '>=':
                                return cellValue >= filterNumber;
                            case '<=':
                                return cellValue <= filterNumber;
                            default:
                                return true;
                        }
                    }

                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        if (settings.nTable !== table.table().node()) {
                            return true;
                        }
                        return filterFunction(settings, data, dataIndex);
                    });

                    function redrawTable() {
                        table.draw();
                    }

                    input.on('keyup change clear', redrawTable);
                    operatorSelect.on('change', redrawTable);
                }
            });
        }
    });
});
</script>

{% endblock %}